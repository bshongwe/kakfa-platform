---
# Chaos Experiment: Kill Kafka Controller
# Expected Outcome: No data loss, new controller elected
---
# ServiceAccount for chaos experiment
apiVersion: v1
kind: ServiceAccount
metadata:
  name: chaos-controller-experiment
  namespace: chaos-testing

---
# Role for accessing Kafka pods
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: chaos-controller-experiment
  namespace: kafka
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/exec"]
    verbs: ["get", "list", "create"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["patch", "update"]

---
# RoleBinding for chaos-testing namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: chaos-controller-experiment
  namespace: kafka
subjects:
  - kind: ServiceAccount
    name: chaos-controller-experiment
    namespace: chaos-testing
roleRef:
  kind: Role
  name: chaos-controller-experiment
  apiGroup: rbac.authorization.k8s.io

---
# ClusterRole for cross-namespace operations
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: chaos-controller-experiment
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: chaos-controller-experiment
subjects:
  - kind: ServiceAccount
    name: chaos-controller-experiment
    namespace: chaos-testing
roleRef:
  kind: ClusterRole
  name: chaos-controller-experiment
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: kill-controller
  namespace: chaos-testing
  annotations:
    experiment.chaos-mesh.org/description: "Kill Kafka controller to test controller failover"
spec:
  action: pod-kill
  mode: one
  selector:
    namespaces:
      - kafka
    labelSelectors:
      strimzi.io/cluster: fintech-kafka
      strimzi.io/kind: Kafka
    
    # Use expression to target the current controller
    expressionSelectors:
      - key: controller
        operator: In
        values: ["true"]
  
  gracePeriod: 0
  duration: "60s"
  
  scheduler:
    cron: "@weekly"

---
# Pre-experiment: Identify controller
apiVersion: batch/v1
kind: Job
metadata:
  name: identify-controller
  namespace: chaos-testing
spec:
  template:
    metadata:
      labels:
        app: chaos-controller-experiment
    spec:
      serviceAccountName: chaos-controller-experiment
      automountServiceAccountToken: true
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: identify
          image: bitnami/kubectl:1.28.4
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
              ephemeral-storage: "100Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
              ephemeral-storage: "200Mi"
          command:
            - sh
            - -c
            - |
              #!/bin/sh
              echo "Finding Kafka controller..."
              
              # Get controller ID
              CONTROLLER_ID=$(kubectl exec -n kafka fintech-kafka-kafka-0 -- \
                kafka-broker-api-versions.sh --bootstrap-server localhost:9092 | \
                grep "Controller" | awk '{print $NF}')
              
              echo "Controller ID: $CONTROLLER_ID"
              echo "Controller broker: fintech-kafka-kafka-${CONTROLLER_ID}"
              
              # Label the controller pod
              kubectl label pod "fintech-kafka-kafka-${CONTROLLER_ID}" \
                -n kafka controller=true --overwrite
              
              echo "Controller labeled for chaos experiment"
      restartPolicy: OnFailure
