---
# Chaos Experiment: Network Partition Between Brokers
# Expected Outcome: ISR stabilizes within 30s
---
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: network-partition
  namespace: chaos-testing
  annotations:
    experiment.chaos-mesh.org/description: "Partition network between Kafka brokers"
spec:
  action: partition
  mode: one
  selector:
    namespaces:
      - kafka
    labelSelectors:
      strimzi.io/cluster: fintech-kafka
      strimzi.io/kind: Kafka
  
  # Direction: isolate one broker from the others
  direction: both
  
  # Target: other Kafka brokers
  target:
    mode: all
    selector:
      namespaces:
        - kafka
      labelSelectors:
        strimzi.io/cluster: fintech-kafka
        strimzi.io/kind: Kafka
  
  duration: "2m"
  
  scheduler:
    cron: "@weekly"

---
# Validation: Check ISR recovery
apiVersion: v1
kind: ConfigMap
metadata:
  name: chaos-network-partition-validation
  namespace: chaos-testing
data:
  validate.sh: |
    #!/bin/bash
    set -e
    
    echo "=== Validating Network Partition Experiment ==="
    
    # Wait for partition to heal
    sleep 30
    
    # 1. Check ISR stability
    echo "Checking ISR stability..."
    
    MAX_ATTEMPTS=10
    ATTEMPT=0
    STABLE=false
    
    while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
      UNDER_REPLICATED=$(kubectl exec -n kafka fintech-kafka-kafka-0 -- \
        kafka-topics.sh --bootstrap-server localhost:9092 \
        --describe --under-replicated-partitions 2>/dev/null | \
        grep -v "Topic:" | wc -l)
      
      if [ "$UNDER_REPLICATED" -eq 0 ]; then
        STABLE=true
        break
      fi
      
      echo "Attempt $((ATTEMPT+1)): $UNDER_REPLICATED under-replicated partitions"
      sleep 3
      ATTEMPT=$((ATTEMPT+1))
    done
    
    if [ "$STABLE" = true ]; then
      echo "✅ ISR stabilized in $((ATTEMPT * 3)) seconds"
    else
      echo "❌ ISR did not stabilize within 30 seconds"
      exit 1
    fi
    
    # 2. Check for data loss
    echo "Checking for data loss..."
    
    # Verify message counts match across replicas
    TOPIC="payments.events"
    
    for i in 0 1 2; do
      OFFSET=$(kubectl exec -n kafka fintech-kafka-kafka-$i -- \
        kafka-run-class.sh kafka.tools.GetOffsetShell \
        --broker-list localhost:9092 \
        --topic $TOPIC \
        --time -1 | awk -F':' '{sum+=$3} END {print sum}')
      
      echo "Broker $i offset: $OFFSET"
    done
    
    echo "✅ Network partition recovery validated"
